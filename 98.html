<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>포켓몬 검색기</title>
    <style>
      @font-face {
        font-family: "Simple";
        src: url("https://cdn.jsdelivr.net/gh/projectnoonnu/noonfonts_2307-1@1.1/Danjo-bold-Regular.woff2")
          format("woff2");
        font-weight: normal;
        font-display: swap;
      }

      body,
      input {
        font-family: "Simple";
      }

      /* section */
      section {
        margin: 1rem 2rem;
      }

      /* controller */
      #search-form {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        align-items: center;
      }

      #search-form * {
        width: 240px;
        margin: 0;
        padding: 0.3rem;
        border: 1px solid grey;
        border-radius: 0.3rem;
      }

      /* 랜덤 버튼 스타일 추가 */
      #random-btn {
        background-color: #ffcb05;
        color: #3d7dca;
        font-weight: bold;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      #random-btn:hover {
        background-color: #3d7dca;
        color: #ffcb05;
        transform: scale(1.05);
      }

      #search-form-btn {
        background-color: #3d7dca;
        color: white;
        cursor: pointer;
      }

      #search-form-btn:hover {
        background-color: #2c5aa0;
      }

      /* container */
      #container,
      #poke-info > section {
        display: flex;
        flex-direction: column;
        gap: 0.3rem;
        align-items: center;
      }

      /* 포켓몬 카드 스타일 개선 */
      #poke-info {
        background: linear-gradient(145deg, #f0f0f0, #ffffff);
        border-radius: 15px;
        padding: 20px;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        max-width: 300px;
        margin: 0 auto;
      }

      #poke-info img {
        width: 150px;
        height: 150px;
        border-radius: 50%;
        background: radial-gradient(circle, #ffffff, #f0f0f0);
        padding: 10px;
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      }

      .poke-name {
        font-size: 1.2em;
        margin: 0.2rem 0;
      }

      #message {
        font-size: 1.1em;
        color: #666;
        text-align: center;
        padding: 20px;
      }

      .hide {
        display: none;
      }

      /* 로딩 애니메이션 */
      .loading {
        color: #3d7dca;
        font-weight: bold;
      }

      .loading::after {
        content: "";
        animation: dots 1.5s infinite;
      }

      @keyframes dots {
        0% {
          content: "";
        }
        25% {
          content: ".";
        }
        50% {
          content: "..";
        }
        75% {
          content: "...";
        }
        100% {
          content: "";
        }
      }
    </style>
  </head>
  <body>
    <section id="controller">
      <form id="search-form">
        <input
          type="text"
          name="poke-name"
          id="poke-name"
          placeholder="포켓몬 이름을 입력해주세요"
        />
        <button type="submit" id="search-form-btn">검색</button>
        <button type="button" id="random-btn">🎲 랜덤 포켓몬</button>
      </form>
    </section>

    <section id="container">
      <div id="message">검색하거나 랜덤 버튼을 눌러보세요!</div>
      <section class="hide" id="poke-info">
        <section>
          <div class="poke-name">
            <strong>이름</strong>: <span id="poke-koname">포켓몬</span>
          </div>
          <div class="poke-name">
            <strong>영어</strong>: <span id="poke-enname">Pokemon</span>
          </div>
          <img src="" alt="포켓몬 사진" />
        </section>
      </section>
    </section>

    <script>
      // 포켓몬 ID를 저장할 변수
      let nameToIdData = {};

      async function changeNameToId(name) {
        // 이미 데이터가 있으면 사용
        if (Object.keys(nameToIdData).length > 0) {
          return nameToIdData[name];
        }

        // 간단화: 처음 151개만 로드 (성능 개선)
        const pokeLength = 152; // 1~151

        try {
          const promises = [];
          for (let i = 1; i < pokeLength; i++) {
            promises.push(fetchPokeKor(i));
          }
          await Promise.all(promises);
          return nameToIdData[name];
        } catch (error) {
          console.error("포켓몬 데이터 로딩 실패:", error);
          return null;
        }
      }

      async function fetchPokeKor(id) {
        const response = await fetch(
          `https://pokeapi.co/api/v2/pokemon-species/${id}`
        );
        if (!response.ok) return;

        const data = await response.json();
        const koNames = data.names.filter((x) => x.language.name === "ko");
        if (koNames.length > 0) {
          nameToIdData[koNames[0].name] = id;
        }
      }

      async function searchPoke(event) {
        event.preventDefault();

        const name = document.querySelector("#poke-name").value.trim();
        if (!name) {
          alert("포켓몬 이름을 입력해주세요!");
          return;
        }

        showLoading();
        await searchName(name);
      }

      async function searchRandomPoke() {
        showLoading();
        // 1~151 중 랜덤 선택
        const randomId = Math.floor(Math.random() * 151) + 1;
        await searchById(randomId);
      }

      async function searchName(name) {
        try {
          const pokeId = await changeNameToId(name);
          if (!pokeId) {
            showMessage("존재하지 않는 포켓몬입니다!");
            return;
          }
          await searchById(pokeId);
        } catch (error) {
          showMessage("검색 중 오류가 발생했습니다!");
          console.error(error);
        }
      }

      async function searchById(pokeId) {
        try {
          // 포켓몬 기본 정보 가져오기
          const response = await fetch(
            `https://pokeapi.co/api/v2/pokemon/${pokeId}`
          );
          if (!response.ok)
            throw new Error("포켓몬 정보를 가져올 수 없습니다!");

          const data = await response.json();

          // 한글 이름 가져오기
          const speciesResponse = await fetch(
            `https://pokeapi.co/api/v2/pokemon-species/${pokeId}`
          );
          const speciesData = await speciesResponse.json();

          const koNames = speciesData.names.filter(
            (x) => x.language.name === "ko"
          );
          const koName = koNames.length > 0 ? koNames[0].name : data.name;

          // UI 업데이트
          document.querySelector("#container img").src =
            data.sprites.front_default;
          document.querySelector("#poke-koname").textContent = koName;
          document.querySelector("#poke-enname").textContent = data.name;

          // 검색창에도 한글 이름 표시
          document.querySelector("#poke-name").value = koName;

          // 결과 표시
          document.querySelector("#poke-info").classList.remove("hide");
          document.querySelector("#message").classList.add("hide");
        } catch (error) {
          showMessage("포켓몬 정보를 불러오는데 실패했습니다!");
          console.error(error);
        }
      }

      function showLoading() {
        document.querySelector("#message").textContent =
          "포켓몬을 찾는 중입니다";
        document.querySelector("#message").className = "loading";
        document.querySelector("#poke-info").classList.add("hide");
        document.querySelector("#message").classList.remove("hide");
      }

      function showMessage(text) {
        document.querySelector("#message").textContent = text;
        document.querySelector("#message").className = "";
        document.querySelector("#poke-info").classList.add("hide");
        document.querySelector("#message").classList.remove("hide");
      }

      // 이벤트 리스너 등록
      document
        .querySelector("#search-form")
        .addEventListener("submit", searchPoke);
      document
        .querySelector("#random-btn")
        .addEventListener("click", searchRandomPoke);

      // 페이지 로드 시 랜덤 포켓몬 하나 표시
      document.addEventListener("DOMContentLoaded", async () => {
        await searchRandomPoke();
      });
    </script>
  </body>
</html>
